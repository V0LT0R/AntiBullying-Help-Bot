# antibullying_bot.py
import asyncio
import os
import re
import json
import csv
from datetime import datetime
from pathlib import Path

from dotenv import load_dotenv
load_dotenv()

from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup
)
from telegram.constants import ParseMode
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

# ===================== GEMINI (google-genai) ================================

from google import genai

# –ö–ª–∏–µ–Ω—Ç –≤–æ–∑—å–º—ë—Ç GEMINI_API_KEY –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
client = genai.Client()

# –û–î–ù–ê —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –ò–ò
async def ai_complete(user_message: str) -> str:
    """
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini.
    –ï—Å–ª–∏ Gemini –≤–¥—Ä—É–≥ –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä ‚Äî –¥–∞—ë–º —Å–≤–æ–π –º—è–≥–∫–∏–π –æ—Ç–≤–µ—Ç.
    """
    system_prompt = (
        "–¢—ã ‚Äî —Ç—ë–ø–ª—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–µ—Ç–µ–π –∏ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤, "
        "–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è —Å –±—É–ª–ª–∏–Ω–≥–æ–º, —Ç—Ä–µ–≤–æ–≥–æ–π, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ–º –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç—è—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å.\n\n"
        "–ü—Ä–∞–≤–∏–ª–∞:\n"
        "1. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º, –±–µ–∑ –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.\n"
        "2. –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏–∑–Ω–∞–≤–∞–π —á—É–≤—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
        "3. –ù–µ –ø–æ–æ—â—Ä—è–π –º–µ—Å—Ç—å, –∞–≥—Ä–µ—Å—Å–∏—é –∏–ª–∏ —Å–∞–º–æ—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ.\n"
        "4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º–∏–Ω–∞–π –≤–∞–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –≤–∑—Ä–æ—Å–ª—ã–º/–ø—Å–∏—Ö–æ–ª–æ–≥—É/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n"
        "5. –û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏.\n\n"
        "–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
    )

    contents = system_prompt + user_message

    try:
        resp = await asyncio.to_thread(
            client.models.generate_content,
            model="gemini-2.5-flash",
            contents=contents
        )

        # –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –¥–æ—Å—Ç–∞—ë–º —Ç–µ–∫—Å—Ç
        text = getattr(resp, "text", "") or ""
        text = text.strip()

        if text:
            return text

        # –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π (safety / —Ñ–∏–ª—å—Ç—Ä) ‚Äî
        # –¥–∞—ë–º —Å–≤–æ–π —Å–æ—á—É–≤—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç, –∞ –Ω–µ "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏".
        return (
            "–Ø —Å–ª—ã—à—É, —á—Ç–æ —Ç–µ–±–µ –Ω–µ–ª–µ–≥–∫–æ –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —è —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, "
            "–∫–∞–∫ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã.\n\n"
            "–¢–æ, —á—Ç–æ —Ç–µ–±—è –æ–±–∑—ã–≤–∞—é—Ç –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ, ‚Äî —ç—Ç–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ –∏ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ. "
            "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω —ç—Ç–æ —Ç–µ—Ä–ø–µ—Ç—å. –ú–æ–∂–Ω–æ:\n"
            "‚Ä¢ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å (—Ä–æ–¥–∏—Ç–µ–ª–∏, —É—á–∏—Ç–µ–ª—å, –∫—É—Ä–∞—Ç–æ—Ä, —à–∫–æ–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥);\n"
            "‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –≤–∑—Ä–æ—Å–ª—ã–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏;\n"
            "‚Ä¢ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±–∏–¥—á–∏–∫–æ–≤.\n\n"
            "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂–∏ —á—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —à–∞–≥–∏ –¥–∞–ª—å—à–µ."
        )

    except Exception as e:
        # –õ–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å, —á—Ç–æ–±—ã –≤—ã –≤–∏–¥–µ–ª–∏ –Ω–∞—Å—Ç–æ—è—â—É—é –æ—à–∏–±–∫—É
        print("Gemini error:", repr(e))

        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –º—è–≥–∫–∏–π –æ—Ç–≤–µ—Ç
        return (
            "–ö–∞–∂–µ—Ç—Å—è, —É –º–µ–Ω—è —Å–µ–π—á–∞—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –∏ —è –Ω–µ –º–æ–≥—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò üòî\n\n"
            "–ù–æ —Ç–æ, —á—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª(–∞), –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∞–∂–Ω–æ. "
            "–¢—ã –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –≤–Ω–∏–∑—É. "
            "–ï—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è –æ—á–µ–Ω—å —Ç—è–∂—ë–ª–∞—è –∏–ª–∏ –æ–ø–∞—Å–Ω–∞—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞—Ç–∏—Å—å –∫ –≤–∑—Ä–æ—Å–ª—ã–º –∏–ª–∏ –Ω–∞ –ª–∏–Ω–∏—é 150 / 112 / 103."
        )

# ===================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê / –ê–ù–û–ù–ò–ú–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ===================

STATS_DIR = Path(os.getenv("STATS_DIR", "stats"))
STATS_DIR.mkdir(parents=True, exist_ok=True)

def _today_csv_path() -> Path:
    return STATS_DIR / f"events_{datetime.utcnow().strftime('%Y-%m-%d')}.csv"

COUNTERS_PATH = STATS_DIR / "counters.json"

class StatsLogger:
    """–ê–Ω–æ–Ω–∏–º–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–Ω–æ–ø–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è, –∫—Ä–∏–∑–∏—Å–Ω—ã–µ —Ñ—Ä–∞–∑—ã."""
    def __init__(self):
        self.lock = asyncio.Lock()
        self._init_csv()
        self.counters = self._load_counters()

    def _init_csv(self):
        p = _today_csv_path()
        if not p.exists():
            with p.open("w", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(["ts_utc", "type", "label", "text"])

    def _load_counters(self):
        if COUNTERS_PATH.exists():
            try:
                return json.loads(COUNTERS_PATH.read_text(encoding="utf-8"))
            except Exception:
                pass
        return {
            "buttons": {
                "p_self": 0, "p_witness": 0, "p_rights": 0,
                "p_hotline": 0, "chat_ai": 0
            },
            "crisis_detected": 0,
            "messages_total": 0,
            "ai_messages": 0
        }

    async def _save_counters(self):
        tmp = COUNTERS_PATH.with_suffix(".json.tmp")
        tmp.write_text(json.dumps(self.counters, ensure_ascii=False, indent=2), encoding="utf-8")
        tmp.replace(COUNTERS_PATH)

    @staticmethod
    def anonymize_text(text: str) -> str:
        """–ú–∞—Å–∫–∏—Ä—É–µ–º email, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, @—é–∑–µ—Ä—ã, —Å—Å—ã–ª–∫–∏."""
        t = text or ""
        t = re.sub(r"[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}", "[email]", t)
        t = re.sub(r"(?:\+?\d[\d\-\s]{6,}\d)", "[phone]", t)
        t = re.sub(r"@\w+", "@user", t)
        t = re.sub(r"https?://\S+|www\.\S+", "[link]", t)
        return t.strip()

    async def log_event(self, event_type: str, label: str = "", text: str = ""):
        atxt = self.anonymize_text(text)
        row = [datetime.utcnow().isoformat(timespec="seconds"), event_type, label, atxt]
        async with self.lock:
            self._init_csv()
            with _today_csv_path().open("a", newline="", encoding="utf-8") as f:
                csv.writer(f).writerow(row)
            if event_type == "button" and label in self.counters["buttons"]:
                self.counters["buttons"][label] += 1
            if event_type == "crisis":
                self.counters["crisis_detected"] += 1
            if event_type == "message":
                self.counters["messages_total"] += 1
            if event_type == "message_ai":
                self.counters["messages_total"] += 1
                self.counters["ai_messages"] += 1
            await self._save_counters()

stats = StatsLogger()

# ===================== UI / –¢–ï–ö–°–¢–´ ==========================================

BOT_NAME = "–ê–Ω—Ç–∏–±—É–ª–ª–∏–Ω–≥ –ë–æ—Ç"

DISCLAIMER = (
    "‚ùóÔ∏è <b>–í–∞–∂–Ω–æ</b>\n\n"
    "–Ø ‚Äî —á–∞—Ç-–±–æ—Ç, –∞ –Ω–µ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –∏ –Ω–µ –≤—Ä–∞—á/—é—Ä–∏—Å—Ç. "
    "–Ø –º–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∏–¥–µ–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã, –Ω–æ –Ω–µ –∑–∞–º–µ–Ω—è—é –ø–æ–º–æ—â—å –≤–∑—Ä–æ—Å–ª—ã—Ö, –ø—Å–∏—Ö–æ–ª–æ–≥–∞ "
    "–∏–ª–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.\n\n"
    "–ï—Å–ª–∏ –µ—Å—Ç—å —É–≥—Ä–æ–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–µ–±–µ –∏–ª–∏ –∫–æ–º—É-—Ç–æ –µ—â—ë) ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–≤–æ–Ω–∏:\n"
    "‚Ä¢ 112 ‚Äî —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã\n"
    "‚Ä¢ 103 ‚Äî —Å–∫–æ—Ä–∞—è –ø–æ–º–æ—â—å\n"
    "‚Ä¢ 150 ‚Äî –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–º–æ—â–∏ –¥–µ—Ç—è–º –∏ –º–æ–ª–æ–¥—ë–∂–∏ (24/7)"
)

HERO_IMAGE = None  # TODO: —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å file_id –∏–ª–∏ URL –æ–±–ª–æ–∂–∫–∏

def main_menu() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton("üôã –Ø —Å—Ç–∞–ª–∫–∏–≤–∞—é—Å—å —Å –±—É–ª–ª–∏–Ω–≥–æ–º", callback_data="p_self")],
        [InlineKeyboardButton("üëÄ –Ø —Å–≤–∏–¥–µ—Ç–µ–ª—å –±—É–ª–ª–∏–Ω–≥–∞", callback_data="p_witness")],
        [InlineKeyboardButton("‚öñÔ∏è –ü—Ä–∞–≤–∞ –∏ –∫—É–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è", callback_data="p_rights")],
        [InlineKeyboardButton("üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å", callback_data="p_hotline")],
        [InlineKeyboardButton("üí¨ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é —Ç–µ–º—É (–ò–ò)", callback_data="chat_ai")],
    ]
    return InlineKeyboardMarkup(buttons)

# –ë–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –∏ —Å–æ—á—É–≤—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–∫—Å—Ç—ã
TEMPLATES = {
    "p_self":
        "–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ —Ç–µ–±–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ —ç—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å. –ë—É–ª–ª–∏–Ω–≥ ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ —Ç—è–∂–µ–ª–æ, "
        "–∏ —Ç—ã –Ω–µ –æ–±—è–∑–∞–Ω —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —ç—Ç–∏–º –≤ –æ–¥–∏–Ω–æ—á–∫—É.\n\n"
        "–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å:\n"
        "1Ô∏è‚É£ <b>–ü—Ä–∏–∑–Ω–∞–π, —á—Ç–æ —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ‚Äî –Ω–µ –Ω–æ—Ä–º–∞.</b> –ù–∏–∫—Ç–æ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ —É–Ω–∏–∂–∞—Ç—å —Ç–µ–±—è, "
        "–∑–∞–ø—É–≥–∏–≤–∞—Ç—å, –≤—ã—Å–º–µ–∏–≤–∞—Ç—å –∏–ª–∏ —Ç—Ä–∞–≤–∏—Ç—å –æ–Ω–ª–∞–π–Ω.\n\n"
        "2Ô∏è‚É£ <b>–°–æ—Ö—Ä–∞–Ω–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞.</b> –°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–æ–∫, —Ñ–æ—Ç–æ, —Å—Å—ã–ª–∫–∏, –¥–∞—Ç—ã, –∏–º–µ–Ω–∞ ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç, "
        "–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤–∑—Ä–æ—Å–ª—ã–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n"
        "3Ô∏è‚É£ <b>–ü–æ–≥–æ–≤–æ—Ä–∏ —Å –∫–µ–º-—Ç–æ –∏–∑ –≤–∑—Ä–æ—Å–ª—ã—Ö, –∫–æ–º—É —Ç—ã –¥–æ–≤–µ—Ä—è–µ—à—å.</b> –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å, –∫–ª–∞—Å—Å–Ω—ã–π "
        "—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å, –∫—É—Ä–∞—Ç–æ—Ä, —à–∫–æ–ª—å–Ω—ã–π –∏–ª–∏ –≤—É–∑–æ–≤—Å–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥. –¢—ã –º–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∞—Ç—å: "
        "¬´–°–æ –º–Ω–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –º–Ω–µ –æ—á–µ–Ω—å –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ –∏ –±–æ–ª—å–Ω–æ. –ú–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å¬ª.\n\n"
        "4Ô∏è‚É£ <b>–ü–æ–¥—É–º–∞–π –æ —Å–≤–æ–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</b> –í —Å–µ—Ç–∏ –º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±–∏–¥—á–∏–∫–∞, –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, "
        "–æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–æ—Ä–∏—Å. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∏–∑–±–µ–≥–∞—Ç—å –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π —Å –∞–≥—Ä–µ—Å—Å–æ—Ä–∞–º–∏ –∏ "
        "–±—ã—Ç—å —Ä—è–¥–æ–º —Å —Ç–µ–º–∏, –∫—Ç–æ —Ç–µ–±–µ –±–µ–∑–æ–ø–∞—Å–µ–Ω.\n\n"
        "5Ô∏è‚É£ <b>–ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–º—ë–∫ –Ω–∞ —É–≥—Ä–æ–∑—É –∂–∏–∑–Ω–∏ –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å—é</b> ‚Äî –Ω–µ –∂–¥–∏. –ó–≤–æ–Ω–∏ 112/103 –∏–ª–∏ 150.\n\n"
        "–¢—ã –≤–∞–∂–µ–Ω(–∞), –∏ —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—Å–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî "
        "—è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å, –∫–∞–∫ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —à–∫–æ–ª–µ –∏–ª–∏ –≤—É–∑—É.",

    "p_witness":
        "–¢–æ, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å –±—É–ª–ª–∏–Ω–≥ –∏ —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ —ç—Ç–æ ‚Äî —É–∂–µ –æ—á–µ–Ω—å –≤–∞–∂–Ω—ã–π –∏ —Å–º–µ–ª—ã–π —à–∞–≥. "
        "–ú–Ω–æ–≥–∏–º –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–º –æ—á–µ–Ω—å –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–∫–∞–∂–µ—Ç: "
        "¬´–¢–æ, —á—Ç–æ —Å —Ç–æ–±–æ–π –¥–µ–ª–∞—é—Ç ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª.\n\n"
        "–í–æ—Ç —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å:\n"
        "1Ô∏è‚É£ <b>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ.</b> –ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ª–∏—á–∫—É –∏–ª–∏ –ø–æ–¥–æ–π—Ç–∏ –ª–∏—á–Ω–æ: "
        "¬´–Ø –≤–∏–∂—É, —á—Ç–æ —Å —Ç–æ–±–æ–π –ø–ª–æ—Ö–æ –æ–±—Ä–∞—â–∞—é—Ç—Å—è. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. –¢—ã –Ω–µ –æ–¥–∏–Ω/–æ–¥–Ω–∞¬ª.\n\n"
        "2Ô∏è‚É£ <b>–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç—Ä–∞–≤–ª–µ.</b> –ù–µ –ª–∞–π–∫–∞—Ç—å, –Ω–µ —Ä–µ–ø–æ—Å—Ç–∏—Ç—å, –Ω–µ —Å–º–µ—è—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –∞–≥—Ä–µ—Å—Å–æ—Ä–∞–º–∏, "
        "–Ω–µ –ø–æ–¥—ã–≥—Ä—ã–≤–∞—Ç—å ¬´—Ä–∞–¥–∏ –∫–æ–º–ø–∞–Ω–∏–∏¬ª.\n\n"
        "3Ô∏è‚É£ <b>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–∫—Ç—ã.</b> –°–∫—Ä–∏–Ω—à–æ—Ç—ã, –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é "
        "–≤–∑—Ä–æ—Å–ª—ã–º.\n\n"
        "4Ô∏è‚É£ <b>–°–æ–æ–±—â–∏—Ç—å –≤–∑—Ä–æ—Å–ª—ã–º.</b> –ú–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º, —É—á–∏—Ç–µ–ª—é, –∫—É—Ä–∞—Ç–æ—Ä—É, —à–∫–æ–ª—å–Ω–æ–º—É –ø—Å–∏—Ö–æ–ª–æ–≥—É, "
        "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ú–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å–ø–æ–∫–æ–π–Ω–æ –∏ –ø–æ —Ñ–∞–∫—Ç–∞–º, –±–µ–∑ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏–π.\n\n"
        "5Ô∏è‚É£ <b>–ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —É–≥—Ä–æ–∑—ã –∂–∏–∑–Ω–∏ –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å—é</b> ‚Äî –ª—É—á—à–µ —Å—Ä–∞–∑—É 112/103 –∏ —Å–æ–≤–µ—Ç –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–º—É "
        "–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ª–∏–Ω–∏—é 150.\n\n"
        "–¢—ã –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—ã –Ω–∞–±–ª—é–¥–∞–µ—à—å ‚Äî —è –ø–æ–º–æ–≥—É –ø—Ä–∏–¥—É–º–∞—Ç—å, –∫–∞–∫ —ç—Ç–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–ø–∏—Å–∞—Ç—å –≤–∑—Ä–æ—Å–ª—ã–º.",

    "p_rights":
        "–£ —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∞–≤–æ –Ω–∞ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ, –∏ –Ω–∏–∫—Ç–æ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –ª–∏—à–∞—Ç—å —Ç–µ–±—è —ç—Ç–æ–≥–æ "
        "–Ω–∏ –≤ —à–∫–æ–ª–µ, –Ω–∏ –≤ –≤—É–∑–µ, –Ω–∏ –æ–Ω–ª–∞–π–Ω.\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:\n"
        "1Ô∏è‚É£ <b>–ü—Ä–∞–≤–æ –Ω–∞ –∑–∞—â–∏—Ç—É –æ—Ç –Ω–∞—Å–∏–ª–∏—è –∏ —É–Ω–∏–∂–µ–Ω–∏—è.</b> –§–∏–∑–∏—á–µ—Å–∫–∏–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥ ‚Äî —ç—Ç–æ –Ω–µ "
        "¬´—à—É—Ç–∫–∞¬ª –∏ –Ω–µ ¬´–Ω–æ—Ä–º–∞ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è¬ª.\n\n"
        "2Ô∏è‚É£ <b>–ü—Ä–∞–≤–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.</b> –¢—ã –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–Ω–æ–º—É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é, "
        "–∫—É—Ä–∞—Ç–æ—Ä—É –≥—Ä—É–ø–ø—ã, –∑–∞–≤—É—á—É, –¥–µ–∫–∞–Ω—É, —à–∫–æ–ª—å–Ω–æ–º—É/–≤—É–∑–æ–≤—Å–∫–æ–º—É –ø—Å–∏—Ö–æ–ª–æ–≥—É. –£ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å "
        "—Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –∏ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å.\n\n"
        "3Ô∏è‚É£ <b>–í–∞–∂–Ω–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã.</b> –ï—Å–ª–∏ –±—É–¥–µ—à—å –ø–∏—Å–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ, –ø—Ä–∏–≥–æ–¥—è—Ç—Å—è: –¥–∞—Ç—ã, –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ, "
        "—É—á–∞—Å—Ç–Ω–∏–∫–∏, —Å–≤–∏–¥–µ—Ç–µ–ª–∏, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã.\n\n"
        "4Ô∏è‚É£ <b>–§–æ—Ä–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è.</b> –ú–æ–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è —É—Å—Ç–Ω–æ (–Ω–∞ –≤—Å—Ç—Ä–µ—á–µ), –∞ –ø–æ—Ç–æ–º ‚Äî –ø–∏—Å—å–º–µ–Ω–Ω–æ. "
        "–í –ø–∏—Å—å–º–µ –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—Å—ã–≤–∞—é—Ç: –∫—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞, –≥–¥–µ –¥–µ–ª–∞–ª, –∏ —á–µ–≥–æ —Ç—ã –ø—Ä–æ—Å–∏—à—å: ¬´–ø—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É¬ª, "
        "¬´–ø—Ä–∏–Ω—è—Ç—å –º–µ—Ä—ã –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏¬ª.\n\n"
        "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî —è –ø–æ–º–æ–≥—É –ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è.",

    "hotline":
        "<b>–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</b>\n\n"
        "–ï—Å–ª–∏ —Ç–µ–±–µ –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ, —Å—Ç—Ä–∞—à–Ω–æ –∏–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –Ω–µ—Ç –≤—ã—Ö–æ–¥–∞ ‚Äî —ç—Ç–æ –Ω–µ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç—ã –æ–¥–∏–Ω/–æ–¥–Ω–∞.\n\n"
        "üìû <b>150</b> ‚Äî –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–º–æ—â–∏ –¥–µ—Ç—è–º –∏ –º–æ–ª–æ–¥—ë–∂–∏ (24/7, –º–æ–∂–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ)\n"
        "üìû <b>112</b> ‚Äî —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã\n"
        "üìû <b>103</b> ‚Äî —Å–∫–æ—Ä–∞—è –ø–æ–º–æ—â—å\n\n"
        "–¢—ã –º–æ–∂–µ—à—å –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∞—Ç—å: ¬´–ú–Ω–µ –æ—á–µ–Ω—å –ø–ª–æ—Ö–æ, —è –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –¥–µ–ª–∞—Ç—å¬ª. "
        "–¢–∞–º —Ä–∞–±–æ—Ç–∞—é—Ç –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–º–µ—é—Ç —Å–ª—É—à–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å."
}

CRISIS_REGEX = re.compile(
    r"(—Ö–æ—á—É\s*—É–º–µ—Ä–µ—Ç—å|–ø–æ–∫–æ–Ω(—á–∏—Ç—å|—á—É)\s*—Å\s*—Å–æ–±–æ–π|—Å—É–∏—Ü–∏–¥|–Ω–µ\s*—Ö–æ—á—É\s*–∂–∏—Ç—å|"
    r"kill\s*myself|suicide|self[-\s]*harm|—É–º—Ä—É\s*–ª—É—á—à–µ)", re.IGNORECASE
)

CRISIS_MESSAGE = (
    "‚ö†Ô∏è <b>–ú–Ω–µ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ —ç—Ç–æ.</b>\n\n"
    "–¢–≤–æ–∏ —Å–ª–æ–≤–∞ –∑–≤—É—á–∞—Ç —Ç–∞–∫, –±—É–¥—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ, "
    "–∏ –º—ã—Å–ª–∏ –º–æ–≥—É—Ç —É—Ö–æ–¥–∏—Ç—å –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏—á–∏–Ω–∏—Ç—å —Å–µ–±–µ –≤—Ä–µ–¥.\n\n"
    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Å—Ç–∞–≤–∞–π—Å—è —Å —ç—Ç–∏–º –æ–¥–∏–Ω/–æ–¥–Ω–∞. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —Ç—ã –º–æ–∂–µ—à—å:\n"
    "‚Ä¢ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ –ª–∏–Ω–∏—é <b>150</b> ‚Äî —Ç–∞–º –º–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ –∏ —Ç–µ–±—è –≤—ã—Å–ª—É—à–∞—é—Ç.\n"
    "‚Ä¢ –ù–∞–±—Ä–∞—Ç—å <b>112</b> –∏–ª–∏ <b>103</b>, –µ—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º —Ç—è–∂—ë–ª–∞—è.\n"
    "‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –≤–∑—Ä–æ—Å–ª–æ–º—É, –∫–æ—Ç–æ—Ä–æ–º—É —Ç—ã —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ –¥–æ–≤–µ—Ä—è–µ—à—å.\n\n"
    "–¢—ã –≤–∞–∂–µ–Ω(–∞). –î–∞–∂–µ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—á–µ–Ω—å –±–æ–ª—å–Ω–æ, —ç—Ç–æ –Ω–µ –Ω–∞–≤—Å–µ–≥–¥–∞. "
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –ø–∞—Ä—É —Å–ª–æ–≤, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–∞–Ω–∏—Ç ‚Äî "
    "—è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ —à–∞–≥–∏ –¥–∞–ª—å—à–µ."
)

AI_FLAG = "ai_chat_mode"

# ===================== –•–≠–ù–î–õ–ï–†–´ =============================================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await stats.log_event("system", "start")

    # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É + –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
    if HERO_IMAGE:
        try:
            await update.effective_chat.send_photo(
                photo=HERO_IMAGE,
                caption=DISCLAIMER,
                parse_mode=ParseMode.HTML,
                reply_markup=main_menu()
            )
            return
        except Exception:
            pass

    await update.effective_chat.send_message(
        DISCLAIMER,
        parse_mode=ParseMode.HTML,
        reply_markup=main_menu()
    )

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await stats.log_event("system", "help")
    await update.message.reply_text(
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help ‚Äî –ø–æ–º–æ—â—å\n"
        "/stopchat ‚Äî –≤—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è —Å –ò–ò"
    )

async def stopchat_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data[AI_FLAG] = False
    await stats.log_event("system", "stopchat")
    await update.message.reply_text(
        "–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –ò–ò –≤—ã–∫–ª—é—á–µ–Ω. "
        "–ú–æ–∂–µ—à—å —Å–Ω–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –≤–Ω–∏–∑—É.",
        reply_markup=main_menu()
    )

async def on_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    key = query.data

    await stats.log_event("button", key)

    chat = query.message.chat

    # –í–ê–ñ–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ edit_message_text
    if key == "p_self":
        await chat.send_message(TEMPLATES["p_self"], parse_mode=ParseMode.HTML, reply_markup=main_menu())
    elif key == "p_witness":
        await chat.send_message(TEMPLATES["p_witness"], parse_mode=ParseMode.HTML, reply_markup=main_menu())
    elif key == "p_rights":
        await chat.send_message(TEMPLATES["p_rights"], parse_mode=ParseMode.HTML, reply_markup=main_menu())
    elif key == "p_hotline":
        await chat.send_message(TEMPLATES["hotline"], parse_mode=ParseMode.HTML, reply_markup=main_menu())
    elif key == "chat_ai":
        context.user_data[AI_FLAG] = True
        await chat.send_message(
            "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–∏—Å–∞—Ç—å –º–Ω–µ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫—É, ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å —Å –ø–æ–º–æ—â—å—é –ò–ò üí¨\n\n"
            "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –≤—ã–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–∂–∏–º, –Ω–∞–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É /stopchat.",
            reply_markup=main_menu()
        )

async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_text = (update.message.text or "").strip()

    # –ö—Ä–∏–∑–∏—Å–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    if CRISIS_REGEX.search(user_text):
        await stats.log_event("crisis", "detected", text=user_text)
        await update.message.reply_html(CRISIS_MESSAGE, reply_markup=main_menu())
        return

    # –†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –ò–ò
    if context.user_data.get(AI_FLAG):
        await stats.log_event("message_ai", "free_chat", text=user_text)
        reply = await ai_complete(user_text)
        await update.message.reply_text(reply)
        return

    # –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ò–ò
    await stats.log_event("message", "general", text=user_text)
    await update.message.reply_text(
        "–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. "
        "–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –≤–Ω–∏–∑—É –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –ò–ò (–∫–Ω–æ–ø–∫–∞ üí¨).",
        reply_markup=main_menu()
    )

async def on_unknown(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await stats.log_event("system", "unknown_command")
    await update.message.reply_text(
        "–Ø –Ω–µ –∑–Ω–∞—é —Ç–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É. –ü–æ–ø—Ä–æ–±—É–π /start –∏–ª–∏ /help."
    )

# ===================== –ó–ê–ü–£–°–ö ===============================================

def main():
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω TELEGRAM_BOT_TOKEN")

    app = Application.builder().token(token).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("stopchat", stopchat_cmd))
    app.add_handler(CallbackQueryHandler(on_button))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_text))
    app.add_handler(MessageHandler(filters.COMMAND, on_unknown))

    print(f"{BOT_NAME} –∑–∞–ø—É—â–µ–Ω. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {STATS_DIR.resolve()}")
    app.run_polling(close_loop=False)

if __name__ == "__main__":
    main()

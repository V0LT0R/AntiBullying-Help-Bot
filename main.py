import os
import random
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

# --- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
ALERT_WORDS = ["—Å—É–∏—Ü–∏–¥", "—É–º–µ—Ä–µ—Ç—å", "–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å", "–ø–ª–æ—Ö–æ", "–¥–µ–ø—Ä–µ—Å—Å–∏—è", "—Ç—Ä–µ–≤–æ–≥–∞", "—Å—Ç—Ä–∞—à–Ω–æ", "–ø–∞–Ω–∏–∫–∞"]
HUMAN_HELP_WORDS = ["–ø—Å–∏—Ö–æ–ª–æ–≥", "—á–µ–ª–æ–≤–µ–∫", "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", "–∂–∏–≤–æ–π", "–æ–ø–µ—Ä–∞—Ç–æ—Ä", "—Ä–µ–∞–ª—å–Ω—ã–π"]

# --- –ù–∞–±–æ—Ä—ã –ø—Ä–∏–º–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ ---
SUPPORT_REPLIES = [
    "–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ —Ç—ã —á–µ—Ä–µ–∑ —ç—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—à—å üíî. –ü–æ–º–Ω–∏: —Ç—ã –Ω–µ –æ–¥–∏–Ω, –∏ —Ç–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî –≤–∞–∂–Ω–æ.",
    "–¢—ã —Å–¥–µ–ª–∞–ª(–∞) –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª(–∞). –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —É–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å –±–æ–ª—å üåø.",
    "–ö–∞–∂–¥—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ —É–≤–∞–∂–µ–Ω–∏–µ. –¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è ‚ù§Ô∏è.",
    "–≠—Ç–æ –∑–≤—É—á–∏—Ç —Ç—è–∂–µ–ª–æ... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –¥–µ—Ä–∂–∏ —ç—Ç–æ –≤ —Å–µ–±–µ. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Ç–µ–±—è –≤—ã—Å–ª—É—à–∞—Ç—å.",
    "–¢—ã –Ω–µ –≤–∏–Ω–æ–≤–∞—Ç(–∞) –≤ —Ç–æ–º, —á—Ç–æ –¥—Ä—É–≥–∏–µ –≤–µ–¥—É—Ç —Å–µ–±—è –ø–ª–æ—Ö–æ. –¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –¥–æ–±—Ä–æ—Ç—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è üí¨.",
    "–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –≤—ã—Ö–æ–¥–∞ –Ω–µ—Ç, –Ω–æ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ –ø—Ä–æ–π–¥—ë—Ç. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ üå±."
]

HELP_REPLIES = [
    "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ üß†. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Å—å –∑–∞ –ø–æ–º–æ—â—å—é:\nüìû 8-800-2000-122 ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ª–∏–Ω–∏—è –¥–æ–≤–µ—Ä–∏—è.",
    "–Ø –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –Ω–æ –∏–Ω–æ–≥–¥–∞ –ª—É—á—à–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –Ω–∞—Å—Ç–æ—è—â–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º. –ú–æ–∂–Ω–æ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ 8-800-2000-122 –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ https://—á–∞—Ç—ã.–¥–æ–≤–µ—Ä–∏–µ.—Ä—Ñ üí¨",
    "–î—É–º–∞—é, —Å–µ–π—á–∞—Å –±—É–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Å–∏—Ö–æ–ª–æ–≥—É. –í–æ—Ç –Ω–∞–¥—ë–∂–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã:\nüí¨ https://—á–∞—Ç—ã.–¥–æ–≤–µ—Ä–∏–µ.—Ä—Ñ\nüìû 8-800-2000-122 (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)."
]

SMALL_TALK = {
    "–ø—Ä–∏–≤–µ—Ç": [
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–¥, —á—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª(–∞) üíö –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?",
        "–ü—Ä–∏–≤–µ—Ç! üåø –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å, —Ä–∞—Å—Å–∫–∞–∂–∏?",
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –≤–∞—Å üí¨."
    ],
    "—Å–ø–∞—Å–∏–±–æ": [
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ üíö. –¢—ã —Å–¥–µ–ª–∞–ª(–∞) –≤–∞–∂–Ω—ã–π —à–∞–≥, –æ–±—Ä–∞—Ç–∏–≤—à–∏—Å—å –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",
        "–†–∞–¥–∞ –ø–æ–º–æ—á—å üåø. –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ.",
        "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ üí¨. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ—Å—Ç–∞–≤–∞–π—Å—è –æ–¥–∏–Ω(–æ–¥–Ω–∞)."
    ],
    "–ø–æ–∫–∞": [
        "–ë–µ—Ä–µ–≥–∏ —Å–µ–±—è üå±. –ï—Å–ª–∏ —Å—Ç–∞–Ω–µ—Ç —Ç—è–∂–µ–ª–æ ‚Äî —è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º.",
        "–•–æ—Ä–æ—à–µ–≥–æ —Ç–µ–±–µ –¥–Ω—è üíö",
        "–î–æ —Å–∫–æ—Ä–æ–≥–æ üåø"
    ]
}

# --- –ï—Å–ª–∏ –ø–æ–∑–∂–µ –∑–∞—Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å OpenAI, –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ—Ç –±–ª–æ–∫ ---
"""
from openai import OpenAI
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

async def support_reply(message: str) -> str:
    prompt = f'''
–¢—ã ‚Äî —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥. –û—Ç–≤–µ—á–∞–π –º—è–≥–∫–æ –∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.
–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{message}"
'''
    completion = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
    )
    return completion.choices[0].message.content.strip()
"""

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ OpenAI ---
async def generate_local_reply(message: str) -> str:
    msg = message.lower().strip()

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ / –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å / –ø—Ä–æ—â–∞–Ω–∏–µ
    for key, options in SMALL_TALK.items():
        if key in msg:
            return random.choice(options)

    # –¢—Ä–µ–≤–æ–∂–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
    if any(word in msg for word in ALERT_WORDS):
        return (
            "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ —Å–µ–π—á–∞—Å —Ç—è–∂–µ–ª–æ üíî\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Å—Ç–∞–≤–∞–π—Å—è –æ–¥–∏–Ω(–æ–¥–Ω–∞). –í–æ—Ç, –∫—É–¥–∞ –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è:\n"
            "üìû –õ–∏–Ω–∏—è –¥–æ–≤–µ—Ä–∏—è: 8-800-2000-122 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)\n"
            "üí¨ –û–Ω–ª–∞–π–Ω-—á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏: https://—á–∞—Ç—ã.–¥–æ–≤–µ—Ä–∏–µ.—Ä—Ñ"
        )

    # –ü—Ä–æ—Å—å–±–∞ –æ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏
    if any(word in msg for word in HUMAN_HELP_WORDS):
        return random.choice(HELP_REPLIES)

    # –û–±—â–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    return random.choice(SUPPORT_REPLIES)


# --- –ö–æ–º–∞–Ω–¥—ã ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = (
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name or '–¥—Ä—É–≥'}! üåø\n\n"
        "–Ø ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª—é–¥–µ–π, "
        "–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥–æ–º –∏–ª–∏ —Ç—Ä–µ–≤–æ–≥–æ–π.\n\n"
        "üí¨ –†–∞—Å—Å–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å."
    )
    await update.message.reply_text(text)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text
    reply = await generate_local_reply(user_message)
    await update.message.reply_text(reply)


# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
def main():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    app.run_polling()


if __name__ == "__main__":
    main()
